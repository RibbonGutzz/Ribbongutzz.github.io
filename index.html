<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Public Location Wall</title>
  
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    body { 
      margin:0; 
      font-family: system-ui, sans-serif; 
      background:#111; 
      color:#eee; 
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #map { 
      flex: 1;
      display: none;           /* hidden at first */
    }
    .intro-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
      background: rgba(0,0,0,0.8);
    }
    .intro-screen.hidden {
      display: none;
    }
    input, button {
      margin: 12px;
      padding: 12px 20px;
      font-size: 1.1em;
      border-radius: 6px;
      border: none;
    }
    button {
      background: #e53e3e;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #c53030; }
    #username { width: 280px; }
    .status { color: #ffcc00; margin: 15px 0; max-width: 500px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC5LJ34tIqk83QLSrNqaDgHY_BGD5hoBuk",
  authDomain: "mapmap-1d259.firebaseapp.com",
  databaseURL: "https://mapmap-1d259-default-rtdb.firebaseio.com",
  projectId: "mapmap-1d259",
  storageBucket: "mapmap-1d259.firebasestorage.app",
  messagingSenderId: "255184564192",
  appId: "1:255184564192:web:1b26b87dbe29a67f1f4585",
  measurementId: "G-L190BWDBFC"
};
    // ======================================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let map = null;
    let markers = null;

    const mapContainer = document.getElementById('map');
    const intro = document.querySelector('.intro-screen');
    const usernameInput = document.getElementById('username');
    const shareBtn = document.getElementById('shareBtn');
    const statusEl = document.getElementById('status');

    function updateStatus(msg) {
      statusEl.textContent = msg;
      console.log("Status:", msg);
    }

    function initMap() {
      if (map) return;

      map = L.map('map', { center: [30, 0], zoom: 2 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
      }).addTo(map);

      markers = L.markerClusterGroup();
      map.addLayer(markers);

      const locationsRef = ref(db, 'public_locations');
      const recentQuery = query(locationsRef, limitToLast(500));

      onValue(recentQuery, (snapshot) => {
        markers.clearLayers();
        const data = snapshot.val();
        console.log("Firebase data received:", data);
        if (!data) return;

        Object.values(data).forEach(point => {
          if (!point.lat || !point.lng) return;
          const marker = L.marker([point.lat, point.lng]);
          marker.bindPopup(`
            <b>${point.nickname || '???'}</b><br>
            ${new Date(point.timestamp).toLocaleString()}<br>
            <small>${point.lat.toFixed(5)}, ${point.lng.toFixed(5)}</small>
          `);
          markers.addLayer(marker);
        });

        if (markers.getLayers().length > 0 && !map._fitDone) {
          map.fitBounds(markers.getBounds(), { padding: [50, 50] });
          map._fitDone = true;
        }
      });

      setTimeout(() => map.invalidateSize({ pan: false }), 300);
    }

    async function requestLocationPermissionAndShare() {
      const nickname = usernameInput.value.trim();
      if (!nickname) {
        updateStatus("Please enter your username first!");
        usernameInput.focus();
        return;
      }

      const consent = confirm(
        `⚠️  VERY IMPORTANT  ⚠️\n\n` +
        `Hello ${nickname},\n` +
        `Your EXACT location + username will be PUBLIC on this map!\n` +
        `Anyone can see it. This is high privacy risk!\n\n` +
        `Continue only if you understand.`
      );
      if (!consent) return;

      // Hide intro, show map
      intro.classList.add('hidden');
      mapContainer.style.display = 'block';
      initMap();

      // Step 1: Check current permission state
      if (!navigator.permissions || !navigator.permissions.query) {
        updateStatus("Your browser doesn't support permission checking. Trying to request location...");
        getLocation();
        return;
      }

      try {
        const permissionStatus = await navigator.permissions.query({ name: "geolocation" });
        console.log("Current geolocation permission state:", permissionStatus.state);

        if (permissionStatus.state === "denied") {
          updateStatus(
            "Location access is permanently blocked for this site.\n\n" +
            "Fix: Click the lock icon next to the URL → Site settings → Location → set to 'Ask (default)' or 'Allow'\n" +
            "Then refresh the page."
          );
          return;
        }

        if (permissionStatus.state === "granted") {
          updateStatus("Location already allowed → getting position...");
          getLocation();
          return;
        }

        // state === "prompt" → normal case, prompt will show when we call getCurrentPosition
        updateStatus("Requesting location permission... (browser prompt should appear now)");
        getLocation();

      } catch (err) {
        console.error("Permission query error:", err);
        updateStatus("Couldn't check permission state. Trying directly...");
        getLocation();
      }
    }

    function getLocation() {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude: lat, longitude: lng } = position.coords;
          console.log("Location success:", lat, lng);
          updateStatus(`Location acquired! Sharing as ${usernameInput.value.trim()}...`);

          push(ref(db, 'public_locations'), {
            lat,
            lng,
            nickname: usernameInput.value.trim(),
            timestamp: Date.now()
          }).then(() => {
            alert(`Success! Your location is now on the map as ${usernameInput.value.trim()}`);
          }).catch(err => {
            console.error("Firebase push error:", err);
            alert("Location got but failed to share: " + err.message);
          });
        },
        (error) => {
          console.error("Geolocation error:", error);
          let msg = "Location error: ";
          switch(error.code) {
            case 1: // PERMISSION_DENIED
              msg += "Permission denied or blocked. Check browser/site settings → Location → reset to 'Ask'";
              break;
            case 2:
              msg += "Position unavailable (no GPS/network?)";
              break;
            case 3:
              msg += "Request timed out – try again";
              break;
            default:
              msg += error.message;
          }
          updateStatus(msg);
          alert(msg);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,      // 15 seconds – give user time
          maximumAge: 0
        }
      );
    }

    shareBtn.addEventListener('click', requestLocationPermissionAndShare);
  </script>
</head>
<body>

  <div class="intro-screen">
    <h1>Public Location Wall</h1>
    <p style="max-width: 600px; margin: 20px auto;">
      <strong>Warning:</strong> This map shows real user locations publicly.<br>
      High privacy risk – only continue if you accept that.
    </p>

    <input type="text" id="username" placeholder="Enter your username/nickname" required>
    <button id="shareBtn">Show map & share my location</button>
    <div id="status" class="status"></div>
  </div>

  <div id="map"></div>

</body>
</html>
